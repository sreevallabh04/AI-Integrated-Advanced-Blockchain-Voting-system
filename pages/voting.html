<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cast Your Vote - SecureVote</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="/assets/css/icon-fonts.css">
  <link rel="stylesheet" href="/assets/css/image-fallbacks.css">
  <!-- Favicon is handled through icon-fonts.css -->
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="page-container">
  <!-- Header will be loaded here -->
  <div id="header-container"></div>
  
  <main class="main-content">
    <div class="container">
      <div class="voting-container">
        <!-- Sidebar -->
        <div class="voting-sidebar">
          <div class="sidebar-header">
            <h2>Current Election</h2>
          </div>
          
          <div class="election-info-panel">
            <div class="election-status">
              <span class="status-badge active">Active</span>
              <h3 id="election-title">Community Proposal Vote</h3>
            </div>
            
            <div class="election-meta">
              <div class="meta-item">
                <i class="icon-time"></i>
                <div>
                  <p class="meta-label">Time Remaining</p>
                  <p class="meta-value" id="election-time-remaining">2 days 5 hours</p>
                </div>
              </div>
              
              <div class="meta-item">
                <i class="icon-users"></i>
                <div>
                  <p class="meta-label">Participants</p>
                  <p class="meta-value" id="election-participants">247</p>
                </div>
              </div>
              
              <div class="meta-item">
                <i class="icon-chart"></i>
                <div>
                  <p class="meta-label">Voter Turnout</p>
                  <p class="meta-value" id="election-turnout">68%</p>
                </div>
              </div>
            </div>
            
            <div class="election-description">
              <h4>About This Vote</h4>
              <p id="election-description">This vote is to decide on the proposed renovation of the community center. The proposal includes expanding the main hall, adding a new children's play area, and updating the technology infrastructure.</p>
            </div>
            
            <div class="election-zkp-info">
              <div class="info-header">
                <h4>Privacy Options</h4>
                <span class="info-badge">
                  <i class="icon-lock"></i> ZKP Available
                </span>
              </div>
              <p>This election supports Zero-Knowledge Proof technology, allowing you to cast a private vote while still ensuring verifiability.</p>
            </div>
          </div>
          
          <div class="navigation-panel">
            <a href="/pages/dashboard.html" class="button outline-button">
              <i class="icon-arrow-left"></i> Back to Dashboard
            </a>
          </div>
        </div>
        
        <!-- Voting Content -->
        <div class="voting-content">
          <div class="voting-header">
            <h1>Cast Your Vote</h1>
            <p class="text-muted">Make your voice heard on the Community Proposal</p>
          </div>
          
              <!-- Account Selection -->
          <div class="voting-card">
            <div class="card-header">
              <h2>1. Connect Your Wallet</h2>
              <p>Use your verified Ethereum wallet to cast your vote on the blockchain</p>
            </div>
            <div class="card-body">
              <div class="account-selection">
                <div class="wallet-status" id="wallet-status">
                  <i class="icon-wallet"></i>
                  <p>Wallet not connected</p>
                </div>
                
                <div class="wallet-action">
                  <button class="button primary-button" id="connect-wallet-btn">Connect Wallet</button>
                </div>
                
                <div class="connected-account" id="connected-account" style="display: none;">
                  <div class="account-info">
                    <div class="account-icon">
                      <i class="icon-user"></i>
                    </div>
                    <div class="account-details">
                      <h4>Connected Account</h4>
                      <p id="account-address" class="address-text">0x0000...0000</p>
                    </div>
                  </div>
                  <div class="account-actions">
                    <button class="button text-button" id="change-account-btn">Change</button>
                  </div>
                </div>
                
                <div class="biometric-verification-status" id="biometric-verification-status">
                  <div class="status-badge verified">
                    <i class="icon-check-circle"></i>
                    <span>Identity Verified via AI Facial Recognition</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="aadhar">Aadhar Number</label>
              <input type="text" id="aadhar" name="aadhar" class="form-control" placeholder="Enter Aadhar Number" required>
            </div>
            <div class="form-group">
              <label for="voterid">Voter ID</label>
              <input type="text" id="voterid" name="voterid" class="form-control" placeholder="Enter Voter ID" required>
            </div>
            <div class="form-group">
              <label for="mobile">Mobile Number</label>
              <input type="tel" id="mobile" name="mobile" class="form-control" placeholder="Enter Mobile Number" required>
            </div>
            <div class="form-group">
              <label for="hardhatAccount">Hardhat Node Account</label>
              <input type="text" id="hardhatAccount" name="hardhatAccount" class="form-control" placeholder="Enter Hardhat Node Account" required>
            </div>
          </div>
          
          <!-- Candidate Selection -->
          <div class="voting-card">
            <div class="card-header">
              <h2>2. Select Your Preferred Option</h2>
              <p>Choose one of the following options</p>
            </div>
            <div class="card-body">
              <div class="candidate-selection">
                <div class="candidate-option">
                  <input type="radio" name="candidate" id="candidate-a" value="A" class="candidate-radio">
                  <label for="candidate-a" class="candidate-label">
                    <div class="option-indicator">A</div>
                    <div class="option-details">
                      <h3>Approve Renovation</h3>
                      <p>Approve the full renovation proposal as presented</p>
                    </div>
                  </label>
                </div>
                
                <div class="candidate-option">
                  <input type="radio" name="candidate" id="candidate-b" value="B" class="candidate-radio">
                  <label for="candidate-b" class="candidate-label">
                    <div class="option-indicator">B</div>
                    <div class="option-details">
                      <h3>Approve Partial Renovation</h3>
                      <p>Approve only the technology infrastructure updates</p>
                    </div>
                  </label>
                </div>
                
                <div class="candidate-option">
                  <input type="radio" name="candidate" id="candidate-c" value="C" class="candidate-radio">
                  <label for="candidate-c" class="candidate-label">
                    <div class="option-indicator">C</div>
                    <div class="option-details">
                      <h3>Reject Renovation</h3>
                      <p>Reject the renovation proposal entirely</p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Justification -->
          <div class="voting-card">
            <div class="card-header">
              <h2>3. Provide Your Justification <span class="optional-badge">Optional</span></h2>
              <p>Share your reasoning for your vote to contribute to our deliberative democracy</p>
            </div>
            <div class="card-body">
              <div class="justification-section">
                <textarea id="justification-input" class="justification-textarea" placeholder="Explain why you voted this way. Your reasoning will be analyzed by our AI system to identify patterns and contribute to the deliberative process."></textarea>
                
                <div class="justification-features">
                  <div class="feature">
                    <i class="icon-ai"></i>
                    <div>
                      <h4>AI Analysis</h4>
                      <p>Your justification will be analyzed for reasoning patterns and cognitive biases</p>
                    </div>
                  </div>
                  
                  <div class="feature">
                    <i class="icon-users"></i>
                    <div>
                      <h4>Collective Intelligence</h4>
                      <p>Your reasoning contributes to our multi-agent deliberative democracy system</p>
                    </div>
                  </div>
                  
                  <div class="feature">
                    <i class="icon-shield"></i>
                    <div>
                      <h4>Privacy Protected</h4>
                      <p>Your identity can be kept private through ZKP while sharing your reasoning</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Privacy Settings -->
          <div class="voting-card">
            <div class="card-header">
              <h2>4. Select Privacy Level</h2>
              <p>Choose how you want your vote to be recorded on the blockchain</p>
            </div>
            <div class="card-body">
              <div class="privacy-options">
                <div class="privacy-option">
                  <input type="radio" name="privacy" id="public-vote" value="public" class="privacy-radio" checked>
                  <label for="public-vote" class="privacy-label">
                    <div class="privacy-icon public">
                      <i class="icon-globe"></i>
                    </div>
                    <div class="privacy-details">
                      <h3>Public Vote</h3>
                      <p>Your account address will be publicly linked to your vote on the blockchain</p>
                    </div>
                  </label>
                </div>
                
                <div class="privacy-option">
                  <input type="radio" name="privacy" id="private-vote" value="private" class="privacy-radio">
                  <label for="private-vote" class="privacy-label">
                    <div class="privacy-icon private">
                      <i class="icon-lock"></i>
                    </div>
                    <div class="privacy-details">
                      <h3>Private Vote (ZKP)</h3>
                      <p>Your vote will be privately recorded using Zero-Knowledge Proofs, keeping your choice secret while ensuring verifiability</p>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="zkp-details" id="zkp-details" style="display: none;">
                <div class="zkp-intro">
                  <i class="icon-info"></i>
                  <p>Zero-Knowledge Proofs allow you to prove you've voted without revealing which option you selected. This helps prevent coercion and maintains vote privacy.</p>
                </div>
                
                <div class="zkp-options">
                  <div class="zkp-input-group">
                    <label for="zkp-secret">Your Secret (Only you will know this)</label>
                    <div class="input-with-action">
                      <input type="password" id="zkp-secret" class="zkp-input" placeholder="Enter a secret phrase or number">
                      <button class="button outline-button" id="generate-secret-btn">Generate</button>
                    </div>
                  </div>
                  
                  <div class="zkp-explainer">
                    <h4>How Zero-Knowledge Proofs Work</h4>
                    <p>When you cast a private vote:</p>
                    <ol class="zkp-steps">
                      <li>A cryptographic proof is generated that confirms you voted without revealing your choice</li>
                      <li>Your vote is recorded anonymously, but verifiably on the blockchain</li>
                      <li>You can later verify your vote was counted correctly using your secret</li>
                    </ol>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Facial Comparison Step -->
          <div class="voting-card" id="facial-comparison-step">
            <div class="card-header">
              <h2>5. Visual Verification</h2>
              <p>Please compare the live camera feed with the reference image.</p>
            </div>
            <div class="card-body">
              <div class="face-match-container">
                <div class="reference-image-container">
                  <h4>Reference Image</h4>
                  <img id="reference-image" src="/images/users/Screenshot 2024-06-18 203605.png" alt="Reference User Image">
                  <p class="text-muted text-small">This is the image stored for verification.</p>
                </div>
                <div class="live-camera-container">
                  <h4>Live Camera Feed</h4>
                  <video id="live-video-feed" autoplay playsinline muted></video>
                  <p class="text-muted text-small">Ensure your face is well-lit and centered in the live feed.</p>
                  <button class="button outline-button button-sm mt-2" id="start-camera-btn">Start Camera</button>
                </div>
              </div>
              <div class="comparison-status" id="comparison-status">
                Click "Start Camera" to begin visual verification.
              </div>
              <div class="vote-decision-buttons" id="vote-decision-buttons" style="display: none;">
                 <p class="mb-3 font-weight-bold">Do you confirm that the person in the live feed is the same as the person in the reference image?</p>
                 <button class="button vote-decision-button yes" id="confirm-match-btn">Yes, They Match</button>
                 <button class="button vote-decision-button no" id="reject-match-btn">No, They Don't Match</button>
              </div>
            </div>
          </div>
          
          <!-- Vote Submission -->
          <div class="submit-section" id="submit-section" style="display: none;"> <!-- Initially hidden -->
            <div class="submission-status" id="submission-status"></div>
            <button class="button primary-button large-button" id="cast-vote-btn" disabled>Cast Your Vote</button>
            <p class="submission-note">Once submitted, your vote cannot be changed</p>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer will be loaded here -->
  <div id="footer-container"></div>
  
  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.0.3/ethers.umd.min.js"></script>
  <script src="/production-config.js"></script>
  <script src="/app.js"></script>
  <script src="/zkp-integration.js"></script>
  
  <!-- Component Loader Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // No login redirect - authentication happens directly in this page
      
      // Load header component
      fetch('/components/header.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          
          // Execute any scripts in the header
          const headerScripts = document.getElementById('header-container').querySelectorAll('script');
          headerScripts.forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.head.appendChild(newScript);
          });
        })
        .catch(error => console.error('Error loading header:', error));
      
      // Load footer component
      fetch('/components/footer.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('footer-container').innerHTML = html;
          
          // Execute any scripts in the footer
          const footerScripts = document.getElementById('footer-container').querySelectorAll('script');
          footerScripts.forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.head.appendChild(newScript);
          });
        })
        .catch(error => console.error('Error loading footer:', error));
      
      // Setup privacy option toggle
      document.querySelectorAll('input[name="privacy"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const zkpDetails = document.getElementById('zkp-details');
          if (this.value === 'private') {
            zkpDetails.style.display = 'block';
          } else {
            zkpDetails.style.display = 'none';
          }
        });
      });
      
      // Generate secret button functionality
      document.getElementById('generate-secret-btn').addEventListener('click', function() {
        const secretInput = document.getElementById('zkp-secret');
        const randomSecret = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        secretInput.value = randomSecret;
      });
      
      // Connect wallet button functionality
      // Start Camera button functionality
      document.getElementById('start-camera-btn').addEventListener('click', async function() {
        try {
          // Get values from input fields
          const aadhar = document.getElementById('aadhar').value;
          const voterId = document.getElementById('voterid').value;
          const mobile = document.getElementById('mobile').value;
          const hardhatAccount = document.getElementById('hardhatAccount').value;
          
          // Validate input
          if (!aadhar || !voterId || !mobile || !hardhatAccount) {
            document.getElementById('comparison-status').innerHTML = `
              <div class="status-message error">
                <i class="icon-error"></i>
                <p>Please fill in all the required fields: Aadhar, Voter ID, Mobile Number, and Ethereum Account.</p>
              </div>
            `;
            return;
          }
          
          // Start biometric verification
          document.getElementById('comparison-status').innerHTML = `
            <div class="status-message loading">
              <div class="spinner"></div>
              <p>Starting camera for biometric verification...</p>
            </div>
          `;
          
          // Use facial-auth.js functionality if available
          if (window.facialAuth) {
            try {
              // Initialize camera
              await window.facialAuth.startCamera(
                document.getElementById('live-video-feed'),
                document.createElement('canvas')
              );
              
              document.getElementById('comparison-status').innerHTML = `
                <div class="status-message info">
                  <i class="icon-info"></i>
                  <p>Camera started. Please position your face in the frame.</p>
                </div>
              `;
              
              // Show verification buttons
              document.getElementById('vote-decision-buttons').style.display = 'block';
              
            } catch (facialError) {
              document.getElementById('comparison-status').innerHTML = `
                <div class="status-message error">
                  <i class="icon-error"></i>
                  <p>Failed to start camera: ${facialError.message}</p>
                </div>
              `;
            }
          } else {
            document.getElementById('comparison-status').innerHTML = `
              <div class="status-message error">
                <i class="icon-error"></i>
                <p>Facial authentication module not found.</p>
              </div>
            `;
          }
        } catch (error) {
          document.getElementById('comparison-status').innerHTML = `
            <div class="status-message error">
              <i class="icon-error"></i>
              <p>Error: ${error.message}</p>
            </div>
          `;
        }
      });
      
      // Confirm match button functionality
      document.getElementById('confirm-match-btn').addEventListener('click', async function() {
        try {
          // Get values from input fields
          const aadhar = document.getElementById('aadhar').value;
          const voterId = document.getElementById('voterid').value;
          const mobile = document.getElementById('mobile').value;
          const hardhatAccount = document.getElementById('hardhatAccount').value;
          
          document.getElementById('comparison-status').innerHTML = `
            <div class="status-message loading">
              <div class="spinner"></div>
              <p>Verifying identity...</p>
            </div>
          `;
          
          // Use facial-auth.js verification
          if (window.facialAuth) {
            try {
              const verificationResult = await window.facialAuth.captureAndVerify();
              
              if (verificationResult.success) {
                document.getElementById('comparison-status').innerHTML = `
                  <div class="status-message success">
                    <i class="icon-check-circle"></i>
                    <p>Identity verified successfully! You can now connect your wallet.</p>
                  </div>
                `;
                
                // Set biometric verification flag
                sessionStorage.setItem('biometricVerified', 'true');
                
                // Stop camera
                window.facialAuth.stopCamera();
                
                // Hide verification buttons
                document.getElementById('vote-decision-buttons').style.display = 'none';
                
                // Enable wallet connection
                document.getElementById('connect-wallet-btn').disabled = false;
              } else {
                document.getElementById('comparison-status').innerHTML = `
                  <div class="status-message error">
                    <i class="icon-error"></i>
                    <p>Verification failed: ${verificationResult.message || 'Identity could not be verified'}</p>
                  </div>
                `;
              }
            } catch (facialError) {
              document.getElementById('comparison-status').innerHTML = `
                <div class="status-message error">
                  <i class="icon-error"></i>
                  <p>Verification error: ${facialError.message}</p>
                </div>
              `;
            }
          }
        } catch (error) {
          document.getElementById('comparison-status').innerHTML = `
            <div class="status-message error">
              <i class="icon-error"></i>
              <p>Error: ${error.message}</p>
            </div>
          `;
        }
      });
      
      // Reject match button functionality
      document.getElementById('reject-match-btn').addEventListener('click', function() {
        // Stop camera
        if (window.facialAuth) {
          window.facialAuth.stopCamera();
        }
        
        document.getElementById('comparison-status').innerHTML = `
          <div class="status-message info">
            <i class="icon-info"></i>
            <p>Verification cancelled. You can try again when ready.</p>
          </div>
        `;
        
        // Hide verification buttons
        document.getElementById('vote-decision-buttons').style.display = 'none';
      });
      
      // Connect wallet button functionality
      document.getElementById('connect-wallet-btn').addEventListener('click', async function() {
        try {
          // Get hardhatAccount value
          const hardhatAccount = document.getElementById('hardhatAccount').value;
          
          if (!hardhatAccount) {
            throw new Error("Please enter a Hardhat Node Account before connecting wallet");
          }
          
          const walletStatus = document.getElementById('wallet-status');
          const connectedAccount = document.getElementById('connected-account');
          const accountAddress = document.getElementById('account-address');
          const castVoteBtn = document.getElementById('cast-vote-btn');
          
          // Show connecting status
          walletStatus.innerHTML = `
            <i class="icon-loading"></i>
            <p>Connecting to Hardhat node...</p>
          `;
          
          // Use hardhatAccount as the wallet address directly
          const userAddress = hardhatAccount;
          
          // Store connected wallet in session storage
          sessionStorage.setItem('walletAddress', userAddress);
          sessionStorage.setItem('walletConnected', 'true');
          
          // Update UI
          walletStatus.innerHTML = `
            <i class="icon-check-circle"></i>
            <p>Connected to Hardhat</p>
          `;
          
          accountAddress.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          connectedAccount.style.display = 'flex';
          
          // Show submit section and enable vote button
          document.getElementById('submit-section').style.display = 'block';
          castVoteBtn.disabled = false;
          
          // Hide the connect button
          this.style.display = 'none';
          
          // Initialize contract
          await initializeContract();
        } catch (error) {
          console.error("Error connecting to Hardhat:", error);
          const errorMessage = document.getElementById('submission-status') || document.createElement('div');
          errorMessage.id = 'submission-status';
          errorMessage.innerHTML = `
            <div class="status-message error">
              <i class="icon-error"></i>
              <p>Failed to connect to Hardhat: ${error.message}</p>
            </div>
          `;
          
          if (!document.getElementById('submission-status')) {
            document.querySelector('.account-selection').appendChild(errorMessage);
          }
          
          // Reset wallet status
          document.getElementById('wallet-status').innerHTML = `
            <i class="icon-wallet"></i>
            <p>Wallet not connected</p>
          `;
        }
      });
      
      // Change account functionality
      document.getElementById('change-account-btn').addEventListener('click', function() {
        document.getElementById('connect-wallet-btn').style.display = 'block';
        document.getElementById('connected-account').style.display = 'none';
        document.getElementById('wallet-status').innerHTML = `
          <i class="icon-wallet"></i>
          <p>Wallet not connected</p>
        `;
        document.getElementById('cast-vote-btn').disabled = true;
      });
      
      // Load Voting contract ABI and address
      let votingContract;
      let provider;
      let signer;
      
      // Initialize contract when wallet is connected
      async function initializeContract() {
        try {
          // Use Hardhat provider and signer from app.js if available
          if (window.provider && window.signer) {
            provider = window.provider;
            signer = window.signer;
            console.log("Using Hardhat provider and signer from app.js");
          } else {
            // Create a new connection to Hardhat node
            console.log("Creating new connection to Hardhat node");
            provider = new ethers.JsonRpcProvider("http://127.0.0.1:8545");
            
            // Use default Hardhat private key (not recommended for production)
            const privateKey = "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"; // Hardhat's default private key
            const wallet = new ethers.Wallet(privateKey, provider);
            signer = wallet;
          }
          
          // Get contract address from production config or environment
          const networkConfig = window.ProductionConfig?.getNetworkConfig();
          let contractAddress = networkConfig?.votingContractAddress;
          
          // Fallback if not found in config
          if (!contractAddress) {
            console.warn("Contract address not found in config, checking for deployed address");
            const deployedAddress = sessionStorage.getItem('votingContractAddress');
            if (!deployedAddress) {
              throw new Error("Voting contract address not found. Please deploy the contract first.");
            }
            contractAddress = deployedAddress;
          }
          
          // Contract ABI - minimal version for the vote function
          const votingAbi = [
            "function vote(uint256 candidateId, string memory justification) external",
            "function hasVoted(address voter) external view returns (bool)",
            "function castSecureVote(uint256 candidateId, string memory justification, bytes memory zkProof) external",
            "event VoteCast(address indexed voter, uint256 candidateId, string justification)"
          ];
          
          votingContract = new ethers.Contract(contractAddress, votingAbi, signer);
          console.log("Voting contract initialized at:", contractAddress);
          
          // Check if user has already voted
          try {
            const userAddress = await signer.getAddress();
            const hasVoted = await votingContract.hasVoted(userAddress);
            
            if (hasVoted) {
              // User already voted
              document.getElementById('submission-status').innerHTML = `
                <div class="status-message info">
                  <i class="icon-info"></i>
                  <p>You have already cast your vote for this election.</p>
                </div>
              `;
              document.getElementById('cast-vote-btn').disabled = true;
            }
          } catch (error) {
            console.warn("Error checking vote status:", error);
          }
          
          return true;
        } catch (error) {
          console.error("Error initializing contract:", error);
          document.getElementById('submission-status').innerHTML = `
            <div class="status-message error">
              <i class="icon-error"></i>
              <p>Error connecting to voting contract: ${error.message}</p>
            </div>
          `;
          return false;
        }
      }
      
      // Cast vote functionality
      document.getElementById('cast-vote-btn').addEventListener('click', async function() {
        const selectedCandidate = document.querySelector('input[name="candidate"]:checked');
        if (!selectedCandidate) {
          document.getElementById('submission-status').innerHTML = `
            <div class="status-message error">
              <i class="icon-error"></i>
              <p>Please select a candidate before voting</p>
            </div>
          `;
          return;
        }
        
        const candidateValue = selectedCandidate.value;
        // Convert selection to candidate ID (0=A, 1=B, 2=C)
        const candidateId = candidateValue === 'A' ? 0 : (candidateValue === 'B' ? 1 : 2);
        
        const justification = document.getElementById('justification-input').value || "No justification provided";
        const privacyMode = document.querySelector('input[name="privacy"]:checked').value;
        const submissionStatus = document.getElementById('submission-status');
        
        submissionStatus.innerHTML = `
          <div class="status-message loading">
            <div class="spinner"></div>
            <p>Processing your vote transaction...</p>
          </div>
        `;
        
        try {
          // Make sure we're connected to the contract
          if (!votingContract) {
            const initialized = await initializeContract();
            if (!initialized) {
              throw new Error("Could not initialize voting contract");
            }
          }
          
          let tx;
          
          if (privacyMode === 'private') {
            const secret = document.getElementById('zkp-secret').value;
            if (!secret) {
              submissionStatus.innerHTML = `
                <div class="status-message error">
                  <i class="icon-error"></i>
                  <p>Please enter a secret for ZKP voting</p>
                </div>
              `;
              return;
            }
            
            // Generate ZKP
            submissionStatus.innerHTML = `
              <div class="status-message loading">
                <div class="spinner"></div>
                <p>Generating zero-knowledge proof...</p>
              </div>
            `;
            
            let zkProof;
            try {
              if (typeof window.zkpIntegration === 'object' && typeof window.zkpIntegration.generateProof === 'function') {
                zkProof = await window.zkpIntegration.generateProof(candidateId, secret);
              } else {
                throw new Error("ZKP module not available");
              }
            } catch (zkpError) {
              console.error("Error generating ZKP:", zkpError);
              throw new Error(`ZKP Error: ${zkpError.message || 'Could not generate zero-knowledge proof'}`);
            }
            
            // Submit private vote with ZKP
            submissionStatus.innerHTML = `
              <div class="status-message loading">
                <div class="spinner"></div>
                <p>Submitting encrypted vote to blockchain...</p>
              </div>
            `;
            
            tx = await votingContract.castSecureVote(candidateId, justification, zkProof);
          } else {
            // Submit regular public vote
            submissionStatus.innerHTML = `
              <div class="status-message loading">
                <div class="spinner"></div>
                <p>Submitting vote to blockchain...</p>
              </div>
            `;
            
            // Call the vote function on the smart contract
            tx = await votingContract.vote(candidateId, justification);
          }
          
          // Wait for transaction confirmation
          submissionStatus.innerHTML = `
            <div class="status-message loading">
              <div class="spinner"></div>
              <p>Waiting for blockchain confirmation...</p>
            </div>
          `;
          
          await tx.wait();
          
          // Vote successfully recorded on the blockchain
          submissionStatus.innerHTML = `
            <div class="status-message success">
              <i class="icon-check-circle"></i>
              <p>Vote successfully cast! Transaction has been confirmed on the blockchain.</p>
              <p class="text-small">Transaction hash: ${tx.hash}</p>
            </div>
          `;
          
          // Disable voting controls after successful vote
          document.getElementById('cast-vote-btn').disabled = true;
          document.querySelectorAll('input[name="candidate"]').forEach(radio => {
            radio.disabled = true;
          });
          document.querySelectorAll('input[name="privacy"]').forEach(radio => {
            radio.disabled = true;
          });
          document.getElementById('justification-input').disabled = true;
          
          // Store vote info in session
          sessionStorage.setItem('userHasVoted', 'true');
          sessionStorage.setItem('voteTxHash', tx.hash);
          
          // Add redirect notification
          setTimeout(function() {
            submissionStatus.innerHTML += `
              <div class="status-message info">
                <i class="icon-info"></i>
                <p>Redirecting to results page in 5 seconds...</p>
              </div>
            `;
            
            // Set redirect timer
            setTimeout(function() {
              window.location.href = '/pages/results.html';
            }, 5000);
          }, 2000);
          
        } catch (error) {
          console.error("Error casting vote:", error);
          let errorMessage = error.message || "Unknown error";
          
          // Check if it's a wallet rejection
          if (errorMessage.includes("user rejected") || errorMessage.includes("User denied")) {
            errorMessage = "Transaction was rejected in your wallet. Please approve the transaction to cast your vote.";
          }
          
          // Check if it's a network error
          if (errorMessage.includes("network") || errorMessage.includes("connection")) {
            errorMessage = "Network error. Please check your internet connection and try again.";
          }
          
          submissionStatus.innerHTML = `
            <div class="status-message error">
              <i class="icon-error"></i>
              <p>Failed to cast vote: ${errorMessage}</p>
            </div>
          `;
        }
      });
      
      // Initialize contract when wallet is connected
      document.addEventListener('walletConnected', initializeContract);
    });
  </script>
  
  <!-- Additional Styles -->
  <style>
    /* Voting specific styles */
    .voting-header {
      margin-bottom: 2rem;
    }
    
    .voting-header h1 {
      margin-bottom: 0.5rem;
    }
    
    .voting-card {
      margin-bottom: 2rem;
    }
    
    .account-selection, .candidate-selection, .justification-section, .privacy-options {
      margin-bottom: 1.5rem;
    }
    
    /* Wallet styling */
    .wallet-status {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .wallet-status i {
      margin-right: 0.5rem;
      font-size: 1.25rem;
    }
    
    .connected-account {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background-color: var(--gray-100);
      border-radius: var(--border-radius);
      margin-top: 1rem;
    }
    
    .account-info {
      display: flex;
      align-items: center;
    }
    
    .account-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-light);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
    }
    
    .address-text {
      font-family: var(--font-mono);
      font-size: 0.875rem;
    }
    
    /* Candidate styling */
    .candidate-option {
      margin-bottom: 1rem;
    }
    
    .candidate-radio {
      display: none;
    }
    
    .candidate-label {
      display: flex;
      padding: 1.25rem;
      border: 2px solid var(--gray-300);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .candidate-radio:checked + .candidate-label {
      border-color: var(--primary);
      background-color: var(--primary-super-light);
    }
    
    .option-indicator {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--gray-200);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      margin-right: 1.25rem;
      flex-shrink: 0;
    }
    
    .candidate-radio:checked + .candidate-label .option-indicator {
      background-color: var(--primary);
      color: white;
    }
    
    .option-details h3 {
      margin-bottom: 0.5rem;
    }
    
    /* Justification styling */
    .justification-textarea {
      width: 100%;
      min-height: 150px;
      padding: 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-family: var(--font-sans);
      margin-bottom: 1.5rem;
      resize: vertical;
    }
    
    .justification-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    
    .feature {
      display: flex;
      align-items: flex-start;
    }
    
    .feature i {
      margin-right: 1rem;
      font-size: 1.25rem;
      color: var(--primary);
    }
    
    .feature h4 {
      margin-bottom: 0.5rem;
    }
    
    /* Privacy options styling */
    .privacy-option {
      margin-bottom: 1.25rem;
    }
    
    .privacy-radio {
      display: none;
    }
    
    .privacy-label {
      display: flex;
      padding: 1.25rem;
      border: 2px solid var(--gray-300);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .privacy-radio:checked + .privacy-label {
      border-color: var(--primary);
      background-color: var(--primary-super-light);
    }
    
    .privacy-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--gray-200);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-right: 1.25rem;
      flex-shrink: 0;
    }
    
    .privacy-icon.public {
      background-color: var(--secondary-light);
      color: white;
    }
    
    .privacy-icon.private {
      background-color: var(--primary-light);
      color: white;
    }
    
    .privacy-details h3 {
      margin-bottom: 0.5rem;
    }
    
    /* ZKP details styling */
    .zkp-details {
      background-color: var(--gray-100);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .zkp-intro {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }
    
    .zkp-intro i {
      margin-right: 1rem;
      font-size: 1.25rem;
      color: var(--info);
    }
    
    .zkp-input-group {
      margin-bottom: 1.5rem;
    }
    
    .zkp-input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .input-with-action {
      display: flex;
    }
    
    .zkp-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius) 0 0 var(--border-radius);
      font-family: var(--font-sans);
    }
    
    .input-with-action .button {
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    
    .zkp-steps {
      padding-left: 1.5rem;
    }
    
    .zkp-steps li {
      margin-bottom: 0.5rem;
    }
    
    /* Submit section styling */
    .submit-section {
      margin-top: 2.5rem;
      text-align: center;
    }
    
    .large-button {
      padding: 1rem 2.5rem;
      font-size: 1.125rem;
    }
    
    .submission-note {
      margin-top: 1rem;
      color: var(--gray-600);
      font-size: 0.875rem;
    }
    
    .submission-status {
      margin-bottom: 1.5rem;
    }
    
    .status-message {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
    }
    
    .status-message.error {
      background-color: rgba(244, 67, 54, 0.1);
      color: var(--error);
    }
    
    .status-message.success {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success);
    }
    
    .status-message.info {
      background-color: rgba(33, 150, 243, 0.1);
      color: var(--info);
    }
    
    .status-message.loading {
      background-color: rgba(33, 150, 243, 0.1);
      color: var(--info);
    }
    
    .status-message i, .status-message .spinner {
      margin-right: 0.75rem;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(33, 150, 243, 0.3);
      border-radius: 50%;
      border-top-color: var(--info);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Election info sidebar styling */
    .election-info-panel {
      background-color: var(--gray-100);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .election-status {
      display: flex;
      flex-direction: column;
      margin-bottom: 1.25rem;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      width: fit-content;
    }
    
    .status-badge.active {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success);
    }
    
    .election-meta {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .meta-item {
      display: flex;
      align-items: flex-start;
    }
    
    .meta-item i {
      margin-right: 0.75rem;
      font-size: 1.25rem;
      color: var(--primary);
    }
    
    .meta-label {
      color: var(--gray-600);
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    
    .meta-value {
      font-weight: 600;
    }
    
    .election-description, .election-zkp-info {
      margin-bottom: 1.5rem;
    }
    
    .election-description h4, .election-zkp-info h4 {
      margin-bottom: 0.75rem;
    }
    
    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    .info-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      background-color: rgba(63, 81, 181, 0.1);
      color: var(--primary);
      border-radius: var(--border-radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .info-badge i {
      margin-right: 0.25rem;
    }
    
    .navigation-panel {
      text-align: center;
    }
    
    .navigation-panel .button {
      width: 100%;
    }
    
    .optional-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      background-color: var(--gray-200);
      color: var(--gray-700);
      border-radius: var(--border-radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      vertical-align: middle;
      margin-left: 0.5rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 991px) {
      .voting-sidebar {
        margin-bottom: 2rem;
      }
    }
  </style>
</body>
</html>
